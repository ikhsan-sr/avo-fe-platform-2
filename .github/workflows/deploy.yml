name: Deploy App

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy
        run: |
          echo "Deploying..."
          sleep 3

      - name: Notify Lark - Success
        if: success()
        run: |
          curl -X POST ${{ secrets.LARK_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "‚úÖ Deployment Success"
                },
                "template": "green"
              },
              "elements": [
                {
                  "tag": "markdown",
                  "content": "**üì¶ Repo:** ${{ github.repository }}"
                },
                {
                  "tag": "markdown",
                  "content": "**üåø Branch:** `${{ github.ref_name }}`"
                },
                {
                  "tag": "markdown",
                  "content": "**üîñ Commit:** `${{ github.sha }}`"
                },
                {
                  "tag": "markdown",
                  "content": "**üë§ Triggered by:** ${{ github.actor }}"
                },
                 {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": { "tag": "plain_text", "content": "üö® Check Logs" },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "type": "danger"
                    }
                  ]
                }
              ]
            }
          }'

      - name: Notify Lark - Failed
        if: failure()
        run: |
          curl -X POST ${{ secrets.LARK_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "‚ùå Deployment Failed"
                },
                "template": "red"
              },
              "elements": [
                { "tag": "markdown", "content": "**üì¶ Repo:** ${{ github.repository }}" },
                { "tag": "markdown", "content": "**üåø Branch:** `${{ github.ref_name }}`" },
                { "tag": "markdown", "content": "**üë§ Triggered by:** ${{ github.actor }}" },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": { "tag": "plain_text", "content": "üö® Check Logs" },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "type": "danger"
                    }
                  ]
                }
              ]
            }
          }'

      - name: Notify Lark - Cancelled
        if: cancelled()
        run: |
          curl -X POST ${{ secrets.LARK_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{ "msg_type": "text", "content": { "text": "‚èπ Deploy CANCELLED - ${{ github.repository }}" }}'
