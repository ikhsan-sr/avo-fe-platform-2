name: Deploy App

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  PR_TITLE: ${{ github.event.pull_request.title || '-' }}
  PR_BODY_RAW: ${{ github.event.pull_request.body || '-' }}
  PR_URL: ${{ github.event.pull_request.html_url || '-' }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Prepare PR Description (truncate)
        id: pr
        run: |
          BODY="${PR_BODY_RAW}"
          BODY_CLEAN=$(echo "$BODY" | tr '\n' ' ' | cut -c1-300)
          echo "PR_BODY=$BODY_CLEAN" >> $GITHUB_ENV

      - name: Deploy
        run: |
          echo "Deploying..."
          sleep 3

      # ========================
      # SUCCESS NOTIFICATION
      # ========================
      - name: Notify Lark - Success
        if: success()
        run: |
          curl -X POST ${{ secrets.LARK_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "‚úÖ Deployment Success: FE Avonetiq"
                },
                "template": "green"
              },
              "elements": [
                { "tag": "markdown", "content": "**üßæ Pull Request Title**\n${{ env.PR_TITLE }}" },
                { "tag": "markdown", "content": "**üìù Pull Request Description**\n${{ env.PR_BODY }}" },
              ]
            }
          }'

      # ========================
      # FAILED NOTIFICATION
      # ========================
      - name: Notify Lark - Failed
        if: failure()
        run: |
          curl -X POST ${{ secrets.LARK_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "‚ùå Deployment Failed"
                },
                "template": "red"
              },
              "elements": [
                { "tag": "markdown", "content": "**üì¶ Repo:** ${{ github.repository }}" },
                { "tag": "markdown", "content": "**üåø Branch:** `${{ github.ref_name }}`" },
                { "tag": "markdown", "content": "**üë§ Triggered by:** ${{ github.actor }}" },

                { "tag": "hr" },

                { "tag": "markdown", "content": "**üßæ Pull Request Title**\n${{ env.PR_TITLE }}" },

                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": { "tag": "plain_text", "content": "üö® Check Logs" },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "type": "danger"
                    }
                  ]
                }
              ]
            }
          }'

      # ========================
      # CANCELLED NOTIFICATION
      # ========================
      - name: Notify Lark - Cancelled
        if: cancelled()
        run: |
          curl -X POST ${{ secrets.LARK_WEBHOOK_URL }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "text",
            "content": {
              "text": "‚èπ Deployment CANCELLED\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}"
            }
          }'
